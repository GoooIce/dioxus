import { hapTasks } from '@ohos/hvigor-ohos-plugin';
import { hvigor, HvigorPlugin, HvigorNode } from '@ohos/hvigor';
import { execFileSync } from 'child_process';
import { resolve } from 'path';

export default {
  system: hapTasks,
  plugins:[dioxusPlugin()]
}

function dioxusPlugin(): HvigorPlugin {
  return {
    pluginId: 'dioxus',
    apply(node: HvigorNode) {
      const buildRustCode = () => {
        const properties = hvigor.getParameter().getProperties();
        const target = properties.target || "aarch64-unknown-linux-ohos";

        console.log('Building Rust library for target:', target);

        try {
          execFileSync('cargo',
            ['build', '--lib', '--target', target.toString()],
            {
              cwd: resolve(__dirname, '{{root_dir_rel}}'),
              stdio: "inherit",
            }
          );
          console.log('Rust library build completed successfully');
        } catch (error) {
          console.error('Rust library build failed:', error);
          throw error;
        }
      }

      // 在 ConfigureCmake 完成后编译 Rust 代码
      node.getTaskByName('default@ConfigureCmake')!.afterRun(buildRustCode);
    }
  }
}
